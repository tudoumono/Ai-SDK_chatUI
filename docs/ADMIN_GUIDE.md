# 管理者ガイド - Admin Guide

このドキュメントは、組織のIT管理者向けに、管理画面の使用方法とセキュリティ設定について説明します。

## 目次

1. [管理画面へのアクセス](#管理画面へのアクセス)
2. [初期設定](#初期設定)
3. [組織IDホワイトリストの管理](#組織idホワイトリストの管理)
4. [パスワード管理](#パスワード管理)
5. [トラブルシューティング](#トラブルシューティング)
6. [セキュリティのベストプラクティス](#セキュリティのベストプラクティス)

---

## 管理画面へのアクセス

### アクセス方法

1. アプリケーションのWelcome画面（`/welcome`）にアクセス
2. 右上の「管理者画面」ボタンをクリック
3. または直接 `/admin` URLにアクセス

### 初回ログイン

**デフォルトパスワード**: `admin123`

⚠️ **重要**: 初回ログイン後、必ずパスワードを変更してください。

---

## 初期設定

### 1. パスワード変更（必須）

初回アクセス時は、セキュリティのため必ずパスワードを変更してください。

**手順**:
1. 管理画面の「パスワード変更」セクションまでスクロール
2. 現在のパスワード: `admin123` を入力
3. 新しいパスワード（6文字以上）を入力
4. 確認用パスワードを再入力
5. 「パスワードを変更」ボタンをクリック

### 2. 組織IDホワイトリストの設定（推奨）

個人のAPIキーの使用を防ぐため、会社配布のAPIキーに紐づく組織IDをホワイトリストに登録します。

---

## 組織IDホワイトリストの管理

### ホワイトリストとは？

OpenAIのAPIキーには組織ID（`org-xxxx`形式）が紐付けられています。このホワイトリスト機能により、**会社配布のAPIキーのみ**を使用できるよう制限できます。

### なぜ必要？

APIキーのプレフィックス（`sk-proj-`など）だけでは、個人のAPIキーと会社配布のAPIキーを区別できません。組織IDを使用することで、確実に会社のAPIキーのみを許可できます。

### 組織IDの取得方法

1. OpenAI APIキーを準備
2. Welcome画面で接続テストを実行
3. ログに表示される組織ID情報を確認

または、OpenAI APIの `/v1/me` エンドポイントを直接呼び出して確認：

```bash
curl https://api.openai.com/v1/me \
  -H "Authorization: Bearer YOUR_API_KEY"
```

レスポンス例：
```json
{
  "orgs": {
    "data": [
      {
        "id": "org-abc123xyz",
        "name": "Your Company Name",
        ...
      }
    ]
  }
}
```

### 組織の追加

1. 管理画面の「Add New Organization」セクションにアクセス
2. 必須フィールドを入力：
   - **Organization ID**: `org-xxxx` 形式のID
   - **Organization Name**: 組織名（任意の名前）
3. オプション：
   - **Notes**: メモ（担当者名、部署など）
4. 「Add Organization」ボタンをクリック

### 組織の編集

1. 組織リストで編集したい組織の「編集」アイコンをクリック
2. 組織名またはメモを変更
3. 「保存」アイコンをクリック

### 組織の削除

1. 組織リストで削除したい組織の「削除」アイコンをクリック
2. 確認ダイアログで「OK」をクリック

⚠️ **注意**: ホワイトリストから組織を削除すると、その組織のAPIキーは使用できなくなります。

---

## パスワード管理

### パスワード変更

**手順**:
1. 管理画面の「パスワード変更」セクションにアクセス
2. 現在のパスワードを入力
3. 新しいパスワード（6文字以上）を入力
4. 確認用パスワードを再入力
5. 「パスワードを変更」ボタンをクリック

### パスワード要件

- **最小文字数**: 6文字
- **推奨**: 英数字と記号を組み合わせた8文字以上

### パスワードの保存場所

パスワードは**ブラウザのlocalStorage**にSHA-256ハッシュとして保存されます。

- ✅ 各ブラウザ・デバイスごとに設定が必要
- ✅ 平文では保存されない（ハッシュ化）
- ⚠️ ブラウザのキャッシュをクリアすると削除される

### セッション管理

- ログイン状態は**sessionStorage**に保存
- **ブラウザを閉じると自動的にログアウト**
- タブを閉じるだけではログアウトしない（同じウィンドウ内）

---

## トラブルシューティング

### パスワードを忘れた場合

**リセット手順**:

1. ブラウザのDevTools（開発者ツール）を開く
   - Windows/Linux: `F12` または `Ctrl+Shift+I`
   - Mac: `Cmd+Option+I`

2. **Application**タブ（Chromeの場合）または**Storage**タブ（Firefoxの場合）を選択

3. 左側のメニューから **Local Storage** → アプリケーションのURL を選択

4. `admin-password-hash` キーを見つけて**削除**

5. ページをリロード（`F5`）

6. デフォルトパスワード `admin123` でログイン

7. **すぐに新しいパスワードに変更**

### ホワイトリストが機能しない

**症状**: ホワイトリストに登録した組織IDでもエラーになる

**確認ポイント**:

1. **組織IDの形式**
   - 正しい形式: `org-abc123xyz`
   - 誤った形式: `abc123xyz`, `org_abc123`, `ORG-ABC123`

2. **APIキーと組織IDの紐付け**
   - `/v1/me` エンドポイントで実際の組織IDを確認
   - 複数の組織に所属している場合、すべての組織IDを登録

3. **ブラウザのキャッシュ**
   - ページをリロード（強制リロード: `Ctrl+Shift+R` / `Cmd+Shift+R`）

### localStorageが保存されない

**原因**: プライベートブラウジングモード（シークレットモード）では、localStorageが制限される場合があります。

**解決策**: 通常のブラウジングモードでアクセスしてください。

---

## セキュリティのベストプラクティス

### 1. 初期パスワードの変更

- ✅ アプリケーション配布後、**即座に**デフォルトパスワードを変更
- ✅ 定期的にパスワードを変更（3〜6ヶ月ごと推奨）

### 2. パスワードの管理

- ✅ パスワードマネージャーを使用
- ❌ パスワードをメールやチャットで共有しない
- ✅ 推測されにくい強固なパスワードを使用

### 3. 組織IDホワイトリストの運用

- ✅ 定期的にホワイトリストを見直し
- ✅ 退職者の組織アクセスを確認
- ✅ 組織IDの変更があった場合は即座に更新

### 4. アクセス制御

- ✅ 管理画面のURLは必要な人にのみ共有
- ✅ 複数の管理者がいる場合、誰がいつ変更したかを記録
- ⚠️ 公開されたドキュメントにパスワードを記載しない

### 5. バックアップ

localStorageはブラウザに依存するため、以下をバックアップしてください：

- 組織IDのリスト（CSVやスプレッドシート）
- 現在のパスワード（安全な場所に保管）

**バックアップ方法**（手動）:
1. 管理画面の組織リストをスクリーンショット
2. または、DevToolsのConsoleで実行：
```javascript
console.log(JSON.stringify(JSON.parse(localStorage.getItem('org-whitelist')), null, 2))
```

---

## よくある質問（FAQ）

### Q1. 複数の管理者が同じパスワードを共有できますか？

**A**: はい、可能です。ただし、セキュリティ上は各管理者が個別のアカウントを持つことが推奨されます。現在のバージョンでは単一のパスワードのみサポートしています。

### Q2. パスワードはサーバーに保存されますか？

**A**: いいえ、パスワードはブラウザのlocalStorageにのみ保存されます。サーバーには送信されません。

### Q3. ホワイトリストが空の場合はどうなりますか？

**A**: ホワイトリストが空（0件）の場合、**すべてのAPIキーが許可**されます。個人のAPIキーも使用可能になるため、必ず組織IDを登録してください。

### Q4. 組織IDは何件まで登録できますか？

**A**: 技術的な制限はありませんが、localStorageの容量（通常5〜10MB）が上限です。一般的な使用では数百件まで問題ありません。

### Q5. モバイルブラウザでも管理画面にアクセスできますか？

**A**: はい、レスポンシブデザインに対応しています。ただし、セキュリティ上、PCでの管理を推奨します。

---

## サポート

問題が解決しない場合は、以下の情報を添えて技術サポートにお問い合わせください：

- ブラウザの種類とバージョン
- エラーメッセージ（スクリーンショット）
- 実行した操作の詳細
- ブラウザのConsoleログ（DevTools → Consoleタブ）

---

## 付録

### A. 組織IDホワイトリストのデータ構造

localStorageに保存されるデータ形式（参考）：

```json
[
  {
    "id": "org-entry-1234567890-abc123",
    "orgId": "org-abc123xyz",
    "orgName": "Company Name",
    "addedAt": "2025-01-15T10:30:00.000Z",
    "notes": "Main organization"
  }
]
```

### B. セキュリティチェックリスト

配布前の確認事項：

- [ ] デフォルトパスワードが変更されている
- [ ] 会社の組織IDがホワイトリストに登録されている
- [ ] テスト用の個人APIキーが**拒否される**ことを確認
- [ ] 会社配布のAPIキーが**承認される**ことを確認
- [ ] 管理画面のアクセス方法を関係者に共有
- [ ] パスワードリセット手順を文書化

---

**バージョン**: 1.0
**最終更新**: 2025年1月
